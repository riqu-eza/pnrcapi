// ====================
// ResortCities Data Models
// ====================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ====================
// ENUMS
// ====================

enum PlaceStatus {
  PENDING
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ====================
// CORE ENTITIES
// ====================

model City {
  id           String    @id @default(cuid())
  name         String
  slug         String    @unique
  country      String
  region       String?
  latitude     Float?
  longitude    Float?
  coverImage   String?
  description  String?
  isActive     Boolean   @default(true)

  // Denormalized stats for fast reads
  totalPlaces  Int       @default(0)
  totalEvents  Int       @default(0)
  categoryCounts Json?   // { dining: 100, accommodation: 50 }

  // Relations
  places       Place[]
  events       Event[]
  blogPosts    BlogPost[]
  categories   CityCategory[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([slug])
  @@index([country, region])
  @@index([isActive])
  @@index([latitude, longitude])
}

model Place {
  id                String       @id @default(cuid())
  name              String
  slug              String       @unique
  shortDescription  String?
  description       String?
  
  // Location
  cityId            String
  city              City         @relation(fields: [cityId], references: [id], onDelete: Cascade)
  address           String?
  latitude          Float?
  longitude         Float?
  area              String?

  // Contact & Visual
  contact           Json?        // { phone, email, website }
  images            Json?        // [{ url, caption, isPrimary, order }]
  coverImage        String?

  // Taxonomy & attributes
  taxonomy          String[]     // ["accommodation", "hotel"]
  attributes        Json?        // Flexible schema per category
  isBookable        Boolean      @default(false)
  pricing           Json?        // { min, max, unit }

  // Operational & status
  status            PlaceStatus  @default(PENDING)
  verificationLevel Int          @default(0) // 0-3
  stats             Json?        // { rating, reviews, bookings }
  bookingSettings   Json?        // { advanceNotice, minDuration, maxDuration, cancellationPolicy }

  ownerId           String?
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  expiresAt         DateTime?
  tags              String[]
  searchKeywords    String[]

  bookings          Booking[]
  reviews           Review[]

  @@index([cityId, status])
  @@index([taxonomy], type: Gin)
  @@index([isBookable])
  @@index([latitude, longitude])
  @@index([slug])
}

// ====================
// CATEGORIES
// ====================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  parentId    String?    @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryParent")
  icon        String?
  description String?
  sortOrder   Int?
  isActive    Boolean    @default(true)

  places      Place[]    @relation("PlaceCategories", references: [id], through: PlaceCategory)

  @@index([slug])
  @@index([isActive])
}

model PlaceCategory {
  placeId     String
  categoryId  String

  place       Place      @relation(fields: [placeId], references: [id])
  category    Category   @relation(fields: [categoryId], references: [id])

  @@id([placeId, categoryId])
}

// ====================
// USERS
// ====================

model AppUser {
  id                  String      @id @default(cuid())
  email               String      @unique
  passwordHash        String
  phone               String?

  profile             Json?       // { firstName, lastName, avatar, bio }
  roles               String[]    // ["tourist", "business_owner", "admin"]
  permissions         String[]
  locationPreferences Json?       // { homeCity, favoriteCities, preferredCategories }
  stats               Json?       // { listingsCount, bookingsCount, reviewsCount }
  settings            Json?       // { notifications, privacy }

  businessProfile     Json?       // Embedded business info
  bookings            Booking[]
  payments            Payment[]
  reviews             Review[]

  createdAt           DateTime    @default(now())
}

model Booking {
  id          String       @id @default(cuid())
  placeId     String
  userId      String
  cityId      String

  place       Place        @relation(fields: [placeId], references: [id])
  user        AppUser      @relation(fields: [userId], references: [id])
  city        City         @relation(fields: [cityId], references: [id])

  startDate   DateTime
  endDate     DateTime
  guests      Json?        // { adults, children, infants }
  specialRequests String?
  
  pricing     Json?        // { base, taxes, fees, discount, total, currency }
  status      BookingStatus @default(PENDING)
  cancellationReason String?

  payment     Payment?

  createdAt   DateTime     @default(now())
  confirmedAt DateTime?
  cancelledAt DateTime?
  completedAt DateTime?

  @@index([userId, status])
  @@index([placeId, startDate])
}

model Payment {
  id          String       @id @default(cuid())
  bookingId   String
  userId      String

  booking     Booking      @relation(fields: [bookingId], references: [id])
  user        AppUser      @relation(fields: [userId], references: [id])

  amount      Float
  currency    String
  method      String       // "mpesa", "card", etc
  provider    String       // "stripe", "pesapal", etc
  transactionId String?
  mpesaDetails Json?       // { phoneNumber, transactionCode, receiptNumber }
  status      PaymentStatus @default(PENDING)
  metadata    Json?

  createdAt   DateTime     @default(now())
}

// ====================
// CONTENT
// ====================

model BlogPost {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  content     String
  excerpt     String?
  featuredImage String?
  authorId    String
  categories  String[]    // Category slugs
  tags        String[]
  relatedCityId String?
  relatedListings String[]
  stats       Json?
  metaTitle   String?
  metaDescription String?
  status      String
  publishedAt DateTime?

  city        City?       @relation(fields: [relatedCityId], references: [id])
}

model Event {
  id          String      @id @default(cuid())
  name        String
  description String?
  organizerId String
  cityId      String
  startDate   DateTime
  endDate     DateTime
  isRecurring Boolean    @default(false)
  recurrencePattern String?
  location    Json?      // { type, venueId, address, coordinates }
  ticketInfo  Json?      // { isFree, price, currency, url, capacity, sold }

  city        City       @relation(fields: [cityId], references: [id])
}

model Review {
  id          String       @id @default(cuid())
  placeId     String
  userId      String
  bookingId   String?
  rating      Int          @default(0)
  title       String?
  content     String?
  pros        String[]
  cons        String[]
  specificRatings Json?   // { cleanliness, service, value, location }
  isVerified  Boolean     @default(false)
  helpfulCount Int        @default(0)
  status      String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  place       Place       @relation(fields: [placeId], references: [id])
  user        AppUser     @relation(fields: [userId], references: [id])
}
